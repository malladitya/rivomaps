<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rivo Navigation</title>
  <meta name="description"
    content="Rivo Navigation helps people with autism and sensory sensitivities find quiet, comfortable routes in cities using AI and community reports." />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Open+Sans:wght@400;600&display=swap"
    rel="stylesheet">

  <!-- Azure Maps SDK -->
  <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css" type="text/css">
  <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"></script>

  <!-- EmailJS SDK -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script src="config.js"></script>
  <script type="text/javascript">
    (function () {
      emailjs.init(window.CONFIG?.emailjsPublicKey || "your_public_id");
    })();
  </script>
  
  <!-- Google Gemini AI SDK -->
  <script type="importmap">
    {
      "imports": {
        "@google/generative-ai": "https://esm.run/@google/generative-ai"
      }
    }
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feedback & Testimonials</title>

  <link rel="stylesheet" href="style.css" />
  <script>
    if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark-mode');
  </script>
</head>

<body>
  <a class="skip-link" href="#main">Skip to main content</a>

  <!-- Welcome Popup -->
  <div id="welcomePopup" class="welcome-overlay" style="display: none;">
    <div class="welcome-popup">
      <button class="welcome-close" aria-label="Close">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      <div class="welcome-icon">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" stroke="#0EA5A2" stroke-width="2" />
          <circle cx="12" cy="10" r="3" fill="#0EA5A2" />
        </svg>
      </div>
      <h2>Welcome to Rivo Navigation</h2>
      <p>Your sensory-friendly navigation companion helping you find quiet, comfortable routes.</p>
      <div class="welcome-features">
        <div class="welcome-feature">
          <span class="feature-emoji">üîá</span>
          <span>Avoid noisy areas</span>
        </div>
        <div class="welcome-feature">
          <span class="feature-emoji">üå≥</span>
          <span>Prefer calm paths</span>
        </div>
        <div class="welcome-feature">
          <span class="feature-emoji">ü§ù</span>
          <span>Community-driven</span>
        </div>
      </div>
      <button class="btn btn--primary btn--lg welcome-btn">
        Get Started
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>
    </div>
  </div>

  <!-- Auth Modal -->
  <div id="authModal" class="auth-modal" style="display: none;">
    <div class="auth-modal-overlay" onclick="closeAuthModal()"></div>
    <div class="auth-modal-content">
      <button class="auth-modal-close" onclick="closeAuthModal()" aria-label="Close">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      
      <div class="auth-container-modal">
        <div class="logo-modal">
          <img src="logo1.png" alt="Rivo Logo">
          <h1>Rivo</h1>
        </div>
        <p style="text-align: center; color: #666; font-size: 14px; margin-bottom: 30px;">Your AI-Powered Navigation Assistant</p>

        <div id="alertModal" class="alert-modal"></div>

        <div id="authFormsModal">
          <div class="tab-buttons-modal">
            <button class="tab-btn-modal active" onclick="switchTabModal('signin')">Sign In</button>
            <button class="tab-btn-modal" onclick="switchTabModal('signup')">Sign Up</button>
          </div>

          <div id="signin-form-modal" class="form-container-modal active">
            <form onsubmit="handleSignInModal(event)">
              <div class="form-group-modal">
                <label for="signin-email-modal">Email</label>
                <input type="email" id="signin-email-modal" required placeholder="you@example.com">
              </div>
              <div class="form-group-modal">
                <label for="signin-password-modal">Password</label>
                <input type="password" id="signin-password-modal" required placeholder="Enter your password">
              </div>
              <div class="forgot-password-modal">
                <a href="#" onclick="showForgotPasswordForm(event)">Forgot Password?</a>
              </div>
              <button type="submit" class="submit-btn-modal" id="signin-btn-modal">Sign In</button>
            </form>

            <div class="divider-modal"><span>OR</span></div>

            <button class="google-btn-modal" onclick="handleGoogleSignInModal()">
              <svg class="google-icon" viewBox="0 0 24 24">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
              </svg>
              Continue with Google
            </button>
          </div>

          <div id="signup-form-modal" class="form-container-modal">
            <form onsubmit="handleSignUpModal(event)">
              <div class="form-group-modal">
                <label for="signup-name-modal">Full Name</label>
                <input type="text" id="signup-name-modal" required placeholder="John Doe">
              </div>
              <div class="form-group-modal">
                <label for="signup-email-modal">Email</label>
                <input type="email" id="signup-email-modal" required placeholder="you@example.com">
              </div>
              <div class="form-group-modal">
                <label for="signup-password-modal">Password</label>
                <input type="password" id="signup-password-modal" required placeholder="At least 6 characters" minlength="6">
              </div>
              <div class="form-group-modal">
                <label for="signup-confirm-modal">Confirm Password</label>
                <input type="password" id="signup-confirm-modal" required placeholder="Re-enter password">
              </div>
              <button type="submit" class="submit-btn-modal" id="signup-btn-modal">Create Account</button>
            </form>

            <div class="divider-modal"><span>OR</span></div>

            <button class="google-btn-modal" onclick="handleGoogleSignInModal()">
              <svg class="google-icon" viewBox="0 0 24 24">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
              </svg>
              Continue with Google
            </button>
          </div>

          <!-- Forgot Password Form -->
          <div id="forgot-password-form-modal" class="form-container-modal">
            <div style="text-align: center; margin-bottom: 20px;">
              <h3 style="margin: 0 0 10px 0; color: #333;">Reset Password</h3>
              <p style="margin: 0; color: #666; font-size: 14px;">Enter your email to receive a password reset link</p>
            </div>
            <form onsubmit="handleForgotPasswordModal(event)">
              <div class="form-group-modal">
                <label for="forgot-email-modal">Email</label>
                <input type="email" id="forgot-email-modal" required placeholder="you@example.com">
              </div>
              <button type="submit" class="submit-btn-modal" id="forgot-btn-modal">Send Reset Link</button>
            </form>
            <div style="text-align: center; margin-top: 15px;">
              <a href="#" onclick="showSignInForm(event)" style="color: #0EA5A2; text-decoration: none; font-size: 14px;">‚Üê Back to Sign In</a>
            </div>
          </div>
        </div>

        <div id="userInfoModal" class="user-info-modal" style="display: none;">
          <div class="user-avatar-modal" id="userAvatarModal">U</div>
          <div class="user-name-modal" id="userNameModal">User Name</div>
          <div class="user-email-modal" id="userEmailModal">user@example.com</div>
          <button class="action-btn-modal" onclick="goToAppModal()">Go to Rivo Maps</button>
          <button class="action-btn-modal" onclick="showChangePasswordForm()">Change Password</button>
          <button class="action-btn-modal signout-btn-modal" onclick="handleSignOutModal()">Sign Out</button>
          <button class="action-btn-modal delete-btn-modal" style="background:#e53935;color:white;border-color:#e53935;margin-top:8px;" onclick="handleDeleteAccountModal()">Delete Account</button>
        </div>

        <!-- Change Password Form -->
        <div id="change-password-form-modal" class="form-container-modal" style="display: none;">
          <div style="text-align: center; margin-bottom: 20px;">
            <h3 style="margin: 0 0 10px 0; color: #333;">Change Password</h3>
            <p style="margin: 0; color: #666; font-size: 14px;">Enter your current and new password</p>
          </div>
          <form onsubmit="handleChangePasswordModal(event)">
            <div class="form-group-modal">
              <label for="current-password-modal">Current Password</label>
              <input type="password" id="current-password-modal" required placeholder="Enter current password">
            </div>
            <div class="form-group-modal">
              <label for="new-password-modal">New Password</label>
              <input type="password" id="new-password-modal" required placeholder="At least 6 characters" minlength="6">
            </div>
            <div class="form-group-modal">
              <label for="confirm-new-password-modal">Confirm New Password</label>
              <input type="password" id="confirm-new-password-modal" required placeholder="Re-enter new password">
            </div>
            <button type="submit" class="submit-btn-modal" id="change-password-btn-modal">Change Password</button>
          </form>
          <div style="text-align: center; margin-top: 15px;">
            <a href="#" onclick="showUserInfoModal()" style="color: #0EA5A2; text-decoration: none; font-size: 14px;">‚Üê Back to Profile</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Theme Toggle -->
  <button id="themeToggle" class="theme-toggle" aria-label="Toggle dark mode">
    <svg class="sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="5" />
      <line x1="12" y1="1" x2="12" y2="3" />
      <line x1="12" y1="21" x2="12" y2="23" />
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
      <line x1="1" y1="12" x2="3" y2="12" />
      <line x1="21" y1="12" x2="23" y2="12" />
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
    </svg>
    <svg class="moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
    </svg>
  </button>

  <div id="site-header-placeholder"></div>

  <main id="main">
    <!-- Hero -->
    <section id="home" class="hero" aria-labelledby="hero-title">
      <div class="container hero-inner">
        <div class="hero-content reveal">
          <div class="hero-badge">
            <span class="badge">üß≠ Sensory-Friendly Navigation</span>
          </div>
          <h1 id="hero-title">Not just the fastest route, but the most comfortable one.</h1>
          <p class="hero-subtitle">
            AI-guided paths that reduce sensory overload‚Äîfavoring quiet streets, parks, and calming spaces for people
            with autism and sensory sensitivities.
          </p>
          <div class="hero-actions">
            <a class="btn btn--primary btn--lg" href="rivo.html">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" fill="currentColor" />
              </svg>
              Try the App
            </a>
            <a class="btn btn--ghost btn--lg" href="#features">
              Explore Features
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M7 13l3 3 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
              </svg>
            </a>
          </div>

          <div class="hero-stats">
            <div class="stat-item">
              <span class="stat-number">üß≠</span>
              <span class="stat-label">Smart Routing</span>
            </div>
            <div class="stat-item">
              <span class="stat-number">‚ö°</span>
              <span class="stat-label">Real-time Updates</span>
            </div>
            <div class="stat-item">
              <span class="stat-number">üéØ</span>
              <span class="stat-label">Comfort-Focused</span>
            </div>
          </div>

          <div class="legend" aria-label="Map legend">
            <div class="legend-item">
              <span class="legend-swatch legend-swatch--quiet" aria-hidden="true"></span>
              <span>Quiet zones</span>
            </div>
            <div class="legend-item">
              <span class="legend-swatch legend-swatch--noisy" aria-hidden="true"></span>
              <span>Noisy zones</span>
            </div>
          </div>
        </div>

        <!-- Azure Map container (3D-wrapped to apply card effect only to map) -->
        <div class="three-d-stage" aria-hidden="false">
          <div class="stage">
            <figure class="card card--map hero-map reveal" aria-describedby="map-desc">
              <div class="map-overlay">
                <div class="map-controls">
                  <button class="map-btn" title="Toggle 3D view">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                      <path d="M12 2l9 4.5v11L12 22l-9-4.5v-11L12 2z" stroke="currentColor" stroke-width="2"
                        fill="none" />
                    </svg>
                  </button>
                  <button class="map-btn" title="Center map">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                      <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" fill="none" />
                      <path
                        d="M12 1v6M12 17v6M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h6M17 12h6M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"
                        stroke="currentColor" stroke-width="2" />
                    </svg>
                  </button>
                </div>
              </div>
              <div id="azureMap" role="img" aria-labelledby="map-title map-desc"></div>
              <div id="map-title" class="sr-only">City map showing quiet and noisy areas with suggested comfortable
                routes</div>
              <div id="map-desc" class="sr-only">Green heat indicates quiet zones; red heat indicates noisy zones. A
                comfort-aware route avoids high-noise areas.</div>
            </figure>
          </div>
        </div>
      </div>
    </section>

    <!-- Quick comparison: Why choose us -->
    <section id="comparison" class="section" aria-labelledby="comparison-title">
      <div class="container reveal">
        <h2 id="comparison-title">Why choose Rivo?</h2>
        <p class="section-intro">A quick comparison to help you choose a navigation tool that prioritizes sensory
          comfort.</p>
        <div class="grid grid--2 comparison-grid">
          <div class="problem-card reveal comparison-card">
            <h3>Rivo ‚Äî designed for comfort</h3>
            <ul>
              <li>Prioritizes quiet & low-crowd routes by default</li>
              <li>Community-sourced sensory reports (noise, crowding, lighting)</li>
              <li>AI forecasts comfort by time and location</li>
              <li>Customizable, gentle alerts and filters</li>
            </ul>
          </div>

          <div class="problem-card reveal comparison-card">
            <h3>Other navigation apps</h3>
            <ul>
              <li>Optimized for fastest or shortest travel time</li>
              <li>Little or no sensory context (noise, crowds)</li>
              <li>No comfort forecasting tailored to sensitivity</li>
              <li>Standard audible notifications by default</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- Problem in easy language -->
    <section id="problem" class="section section--alt" aria-labelledby="problem-title">
      <div class="container reveal">
        <h2 id="problem-title">The problem in easy language</h2>
        <div class="problem-grid">
          <div class="problem-card">
            <h3>Why moving around is hard</h3>
            <ul>
              <li>Some places are too noisy (traffic, crowds, construction).</li>
              <li>Some routes are too crowded (markets, stations).</li>
              <li>People don‚Äôt know in advance which areas will feel comfortable or overwhelming.</li>
            </ul>
          </div>
          <div class="problem-card">
            <h3>Why it matters</h3>
            <ul>
              <li>Stress and anxiety increase in noisy or crowded places.</li>
              <li>Families and caregivers struggle to plan calm routes.</li>
              <li>Many avoid going out, reducing freedom and independence.</li>
            </ul>
          </div>
          <div class="problem-card">
            <h3>What current apps miss</h3>
            <p>Most navigation apps only show the fastest or shortest route. They don‚Äôt tell you which path is quiet,
              less crowded, or sensory-friendly.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Features -->
    <section id="features" class="section" aria-labelledby="features-title">
      <div class="container">
        <div class="section-header reveal">
          <h2 id="features-title">Designed for comfort and accessibility</h2>
          <p class="section-intro">Every feature is built with sensory sensitivities in mind, creating a navigation
            experience that truly understands your needs.</p>
        </div>

        <div class="features-grid">
          <article class="feature-card feature-card--primary reveal">
            <div class="feature-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="32" height="32">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"
                  fill="#0EA5A2"></path>
              </svg>
            </div>
            <h3 class="feature-title">Real-time community reports</h3>
            <p class="feature-text">Get live updates from our community about noise levels, crowding, construction, and
              lighting conditions along your route.</p>
            <div class="feature-tags">
              <span class="tag">Live updates</span>
              <span class="tag">Community-driven</span>
            </div>
          </article>

          <article class="feature-card feature-card--secondary reveal">
            <div class="feature-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="32" height="32">
                <circle cx="12" cy="12" r="3" fill="none" stroke="#3B82F6" stroke-width="2"></circle>
                <path
                  d="M12 1v6M12 17v6M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h6M17 12h6M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"
                  stroke="#3B82F6" stroke-width="2"></path>
              </svg>
            </div>
            <h3 class="feature-title">AI comfort predictions</h3>
            <p class="feature-text">Advanced algorithms forecast comfort levels throughout the day, helping you plan the
              perfect time for your journey.</p>
            <div class="feature-tags">
              <span class="tag">AI-powered</span>
              <span class="tag">Predictive</span>
            </div>
          </article>

          <article class="feature-card feature-card--accent reveal">
            <div class="feature-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="32" height="32">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" fill="none" stroke="#22C55E" stroke-width="2">
                </path>
                <circle cx="12" cy="10" r="3" fill="#22C55E"></circle>
              </svg>
            </div>
            <h3 class="feature-title">Sensory-optimized routes</h3>
            <p class="feature-text">Smart routing that prioritizes quiet streets, parks, and calming environments while
              avoiding high-stimulus areas.</p>
            <div class="feature-tags">
              <span class="tag">Smart routing</span>
              <span class="tag">Sensory-aware</span>
            </div>
          </article>

          <article class="feature-card feature-card--warning reveal">
            <div class="feature-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="32" height="32">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"
                  fill="none" stroke="#F59E0B" stroke-width="2"></path>
                <line x1="12" y1="9" x2="12" y2="13" stroke="#F59E0B" stroke-width="2"></line>
                <circle cx="12" cy="17" r="1" fill="#F59E0B"></circle>
              </svg>
            </div>
            <h3 class="feature-title">Gentle, customizable alerts</h3>
            <p class="feature-text">Soft notifications that respect your sensory preferences‚Äîno sudden sounds or
              overwhelming visual alerts.</p>
            <div class="feature-tags">
              <span class="tag">Customizable</span>
              <span class="tag">Gentle</span>
            </div>
          </article>
        </div>
      </div>
    </section>
    <!-- new ui for map -->


    <!-- Demo -->
    <section id="demo" class="section section--alt" aria-labelledby="demo-title">
      <div class="container reveal">
        <div class="section-header">
          <h2 id="demo-title">Experience the difference</h2>
          <p class="section-intro">Try our route planner and see how we prioritize your comfort and sensory needs.</p>
        </div>

        <div class="demo-container">
          <div class="demo-box">
            <div class="demo-header">
              <h3>Plan your comfortable route</h3>
              <p>Enter your journey details and we'll find the most sensory-friendly path.</p>
            </div>

            <div class="demo-form">
              <div class="input-group">
                <label for="origin">From</label>
                <div class="input-wrapper">
                  <svg class="input-icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                    <circle cx="12" cy="12" r="3" fill="currentColor" />
                  </svg>
                  <input type="text" id="origin" placeholder="Enter starting location" />
                  <button id="locate-origin" class="map-btn" title="Use current location"
                    style="position: absolute; right: 8px; padding: 4px; background: transparent; border: none; cursor: pointer; color: var(--Rivo-500);">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="12" y1="1" x2="12" y2="4"></line>
                      <line x1="12" y1="20" x2="12" y2="23"></line>
                      <line x1="4.22" y1="4.22" x2="6.34" y2="6.34"></line>
                      <line x1="17.66" y1="17.66" x2="19.78" y2="19.78"></line>
                      <line x1="1" y1="12" x2="4" y2="12"></line>
                      <line x1="20" y1="12" x2="23" y2="12"></line>
                      <line x1="4.22" y1="19.78" x2="6.34" y2="17.66"></line>
                      <line x1="17.66" y1="6.34" x2="19.78" y2="4.22"></line>
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                  </button>
                </div>
              </div>

              <div class="input-group">
                <label for="destination">To</label>
                <div class="input-wrapper">
                  <svg class="input-icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" stroke="currentColor" stroke-width="2" />
                    <circle cx="12" cy="10" r="3" fill="currentColor" />
                  </svg>
                  <input type="text" id="destination" placeholder="Enter destination" />
                </div>
              </div>

              <div class="comfort-settings">
                <h4>Comfort preferences</h4>
                <div class="preference-grid">
                  <label class="preference-item" for="pref-noise">
                    <input type="checkbox" id="pref-noise" checked>
                    <span class="checkmark"></span>
                    <span>Avoid noisy areas</span>
                  </label>
                  <label class="preference-item" for="pref-crowds">
                    <input type="checkbox" id="pref-crowds" checked>
                    <span class="checkmark"></span>
                    <span>Minimize crowds</span>
                  </label>
                  <label class="preference-item" for="pref-green">
                    <input type="checkbox" id="pref-green">
                    <span class="checkmark"></span>
                    <span>Prefer parks & green spaces</span>
                  </label>
                  <label class="preference-item" for="pref-const">
                    <input type="checkbox" id="pref-const">
                    <span class="checkmark"></span>
                    <span>Avoid construction zones</span>
                  </label>
                </div>
              </div>

              <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                <button onclick="goToReportZone('noise')" class="btn" style="flex: 1;">üîä Report Noise</button>
                <button onclick="goToReportZone('crowd')" class="btn" style="flex: 1;">üë• Report Crowd</button>
              </div>
              <button onclick="checkComfort()" class="btn" style="width: 100%; margin-bottom: 12px;">ü§ñ Check Comfort
                Level</button>
              <a href="rivo.html" class="btn btn--primary btn--lg demo-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" stroke="currentColor" stroke-width="2" />
                  <circle cx="12" cy="10" r="3" fill="currentColor" />
                </svg>
                Find comfortable route
              </a>
            </div>

            <div class="demo-status">
              <div class="status-item">
                <span class="status-dot status-dot--success"></span>
                <span>Real-time data connected</span>
              </div>
              <div class="status-item">
                <span class="status-dot status-dot--success"></span>
                <span>AI comfort analysis ready</span>
              </div>
              <div class="status-item">
                <span class="status-dot status-dot--success"></span>
                <span id="community-reports-count">0 community reports</span>
              </div>
            </div>
          </div>

          <div class="demo-preview">
            <div class="preview-header">
              <h4>Route comparison</h4>
              <p>See the difference between standard and comfort-aware routing</p>
            </div>

            <div class="route-comparison">
              <div class="route-option route-option--standard">
                <div class="route-header">
                  <span class="route-type">Standard route</span>
                  <span class="route-time">12 min</span>
                </div>
                <div class="route-stats">
                  <div class="stat">
                    <span class="stat-label">Noise level</span>
                    <div class="stat-bar">
                      <div class="stat-fill" style="width: 85%; background: var(--noisy);"></div>
                    </div>
                  </div>
                  <div class="stat">
                    <span class="stat-label">Crowd density</span>
                    <div class="stat-bar">
                      <div class="stat-fill" style="width: 70%; background: var(--noisy);"></div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="route-option route-option--comfort">
                <div class="route-header">
                  <span class="route-type">Comfort route</span>
                  <span class="route-time">15 min</span>
                  <span class="route-badge">Recommended</span>
                </div>
                <div class="route-stats">
                  <div class="stat">
                    <span class="stat-label">Noise level</span>
                    <div class="stat-bar">
                      <div class="stat-fill" style="width: 25%; background: var(--quiet);"></div>
                    </div>
                  </div>
                  <div class="stat">
                    <span class="stat-label">Crowd density</span>
                    <div class="stat-bar">
                      <div class="stat-fill" style="width: 30%; background: var(--quiet);"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Report Zone Section -->
      <section id="report-zone" class="section section--alt" aria-labelledby="report-zone-title">
        <div class="container reveal">
          <h2 id="report-zone-title">Report a Zone</h2>
          <p class="section-intro">Help the community by reporting noisy or construction areas. Zones auto-expire in 5 minutes.</p>
          
          <div class="report-zone-card">
            <div class="report-zone-form">
              <!-- Place Name Input -->
              <div class="report-input-group">
                <label for="reportPlaceInputIndex" class="report-label">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                  </svg>
                  Location
                </label>
                <div class="report-input-wrapper">
                  <input type="text" id="reportPlaceInputIndex" 
                    class="report-input"
                    placeholder="Enter place name (e.g., Sector 17, Chandigarh)"
                    autocomplete="off">
                  <button type="button" id="useCurrentLocationBtn" class="current-location-btn" title="Use current location">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <circle cx="12" cy="12" r="3"/>
                      <line x1="12" y1="2" x2="12" y2="6"/>
                      <line x1="12" y1="18" x2="12" y2="22"/>
                      <line x1="2" y1="12" x2="6" y2="12"/>
                      <line x1="18" y1="12" x2="22" y2="12"/>
                    </svg>
                  </button>
                  <div id="reportPlaceSuggestionsIndex" class="report-suggestions"></div>
                </div>
              </div>
              
              <!-- Zone Type Dropdown -->
              <div class="report-input-group">
                <label for="reportZoneTypeIndex" class="report-label">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/>
                    <circle cx="12" cy="10" r="3"/>
                  </svg>
                  Zone Type
                </label>
                <select id="reportZoneTypeIndex" class="report-select">
                  <option value="noise">üîä Noise Zone</option>
                  <option value="crowd">üë• Crowded Area</option>
                  <option value="construction">üöß Construction Zone</option>
                </select>
              </div>
              
              <!-- Report Button -->
              <button id="reportZoneBtnIndex" class="btn btn--primary report-btn" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
                Report Zone
              </button>
            </div>
            
            <!-- Status Message -->
            <div id="reportStatusIndex" class="report-status" style="display: none;">
              <span id="reportStatusIconIndex" class="report-status-icon">‚úì</span>
              <span id="reportStatusTextIndex"></span>
            </div>
          </div>
        </div>
      </section>

      <!-- Testimonials -->
      <section id="testimonials" class="section" aria-labelledby="testimonials-title">
        <div class="container">
          <h2 id="testimonials-title">What people say</h2>
          <div class="grid grid--2">
            <blockquote class="quote reveal">
              <p>‚ÄúFor the first time, I can choose paths that feel good to me‚Äînot just fast.‚Äù</p>
              <footer><cite>Ananya, student</cite></footer>
            </blockquote>
            <blockquote class="quote reveal">
              <p>‚ÄúThe alerts help me avoid loud areas when I‚Äôm already stressed. It‚Äôs a relief.‚Äù</p>
              <footer><cite>Rahul, designer</cite></footer>
            </blockquote>
          </div>
        </div>
      </section>

      <!-- Contact -->
      <section id="contact" class="section section--alt" aria-labelledby="contact-title">
        <div class="container reveal">
          <h2 id="contact-title">Contact us</h2>
          <p class="section-intro">Questions or ideas? We‚Äôd love to hear from you.</p>
          <form class="contact-form" aria-describedby="contact-help">
            <div class="input-row">
              <div class="input-group">
                <label for="name">Name</label>
                <input id="name" name="name" type="text" autocomplete="name" required />
              </div>
              <div class="input-group">
                <label for="email">Email</label>
                <input id="email" name="email" type="email" autocomplete="email" required />
              </div>
            </div>
            <div class="input-group">
              <label for="message">Message</label>
              <textarea id="message" name="message" rows="4" required></textarea>
            </div>
            <button type="submit" class="btn btn--primary">Send</button>
            <p id="contact-help" class="form-hint">We respond within 2‚Äì3 business days.</p>
          </form>
        </div>
      </section>
      <!-- Feedback & Testimonials -->

      <div id="site-footer-placeholder"></div>

      <script src="layout.js"></script>
      <script src="global-auth.js"></script>
      <script src="script.js"></script>
      <script src="helpers.js"></script>
      
      <!-- Report Zone Functionality -->
      <script>
        // Report Zone by Place Name
        (function() {
          let reportPlaceCoords = null;
          
          const reportInput = document.getElementById('reportPlaceInputIndex');
          const reportSuggestions = document.getElementById('reportPlaceSuggestionsIndex');
          const reportBtn = document.getElementById('reportZoneBtnIndex');
          const reportStatus = document.getElementById('reportStatusIndex');
          const reportStatusText = document.getElementById('reportStatusTextIndex');
          const reportStatusIcon = document.getElementById('reportStatusIconIndex');
          const zoneTypeSelect = document.getElementById('reportZoneTypeIndex');
          
          if (!reportInput || !reportBtn) return;
          
          // Debounce helper
          const debounce = (func, wait) => {
            let timeout;
            return function(...args) {
              clearTimeout(timeout);
              timeout = setTimeout(() => func(...args), wait);
            };
          };
          
          // Fetch place suggestions from Nominatim
          const fetchSuggestions = debounce(async (query) => {
            if (query.length < 3) {
              reportSuggestions.classList.remove('active');
              return;
            }
            
            try {
              const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`;
              const response = await fetch(url);
              const results = await response.json();
              
              reportSuggestions.innerHTML = '';
              
              if (results.length === 0) {
                reportSuggestions.classList.remove('active');
                return;
              }
              
              results.forEach(result => {
                const div = document.createElement('div');
                div.className = 'report-suggestion-item';
                div.innerHTML = `
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                  </svg>
                  <span>${result.display_name}</span>
                `;
                div.addEventListener('click', () => {
                  reportInput.value = result.display_name.split(',')[0];
                  reportPlaceCoords = {
                    lat: parseFloat(result.lat),
                    lng: parseFloat(result.lon),
                    name: result.display_name.split(',')[0]
                  };
                  reportSuggestions.classList.remove('active');
                  reportBtn.disabled = false;
                });
                reportSuggestions.appendChild(div);
              });
              
              reportSuggestions.classList.add('active');
              
            } catch (error) {
              console.error("Geocoding error:", error);
            }
          }, 500);
          
          // Input event
          reportInput.addEventListener('input', (e) => {
            reportPlaceCoords = null;
            reportBtn.disabled = true;
            fetchSuggestions(e.target.value);
          });
          
          // Close suggestions on outside click
          document.addEventListener('click', (e) => {
            if (!e.target.closest('#reportPlaceInputIndex') && !e.target.closest('#reportPlaceSuggestionsIndex')) {
              reportSuggestions.classList.remove('active');
            }
          });
          
          // Show status message
          function showStatus(type, message) {
            reportStatus.style.display = 'flex';
            reportStatus.className = 'report-status ' + type;
            reportStatusText.textContent = message;
            reportStatusIcon.textContent = type === 'success' ? '‚úì' : '‚úó';
            
            setTimeout(() => {
              reportStatus.style.display = 'none';
            }, 5000);
          }
          
          // Report button click
          reportBtn.addEventListener('click', async () => {
            if (!reportPlaceCoords) return;
            
            const zoneType = zoneTypeSelect.value;
            const { lat, lng, name } = reportPlaceCoords;
            
            // Disable button
            reportBtn.disabled = true;
            const originalHTML = reportBtn.innerHTML;
            reportBtn.innerHTML = `
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spin">
                <circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="32"/>
              </svg>
              Adding...
            `;
            
            try {
              // Save to localStorage with timestamp
              const savedZones = JSON.parse(localStorage.getItem('userReportedZones') || '[]');
              savedZones.push({
                coords: [lng, lat],
                type: zoneType,
                name: name,
                timestamp: Date.now()
              });
              localStorage.setItem('userReportedZones', JSON.stringify(savedZones));
              
              // Show success
              const zoneLabels = { noise: 'Noise', crowd: 'Crowded', construction: 'Construction' };
              const zoneLabel = zoneLabels[zoneType] || zoneType;
              showStatus('success', `${zoneLabel} zone reported at "${name}" - expires in 5 min`);
              
              // Clear input
              reportInput.value = '';
              reportPlaceCoords = null;
              
              console.log(`üìç Zone reported: ${name} at [${lat}, ${lng}]`);
              
            } catch (error) {
              console.error("Error reporting zone:", error);
              showStatus('error', 'Failed to report zone. Please try again.');
            }
            
            // Reset button
            reportBtn.innerHTML = originalHTML;
          });
          
          // Clean up expired zones (older than 5 minutes)
          function cleanupExpiredZones() {
            const FIVE_MINUTES = 5 * 60 * 1000;
            const savedZones = JSON.parse(localStorage.getItem('userReportedZones') || '[]');
            const activeZones = savedZones.filter(zone => (Date.now() - zone.timestamp) < FIVE_MINUTES);
            localStorage.setItem('userReportedZones', JSON.stringify(activeZones));
          }
          
          // Run cleanup on load and periodically
          cleanupExpiredZones();
          setInterval(cleanupExpiredZones, 60000);
          
          // Current Location Button
          const currentLocationBtn = document.getElementById('useCurrentLocationBtn');
          if (currentLocationBtn) {
            currentLocationBtn.addEventListener('click', async () => {
              currentLocationBtn.classList.add('loading');
              
              if (!navigator.geolocation) {
                showStatus('error', 'Geolocation is not supported by your browser');
                currentLocationBtn.classList.remove('loading');
                return;
              }
              
              navigator.geolocation.getCurrentPosition(
                async (position) => {
                  const lat = position.coords.latitude;
                  const lng = position.coords.longitude;
                  
                  // Reverse geocode to get place name
                  try {
                    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    const placeName = data.address?.suburb || data.address?.neighbourhood || 
                                     data.address?.village || data.address?.town || 
                                     data.address?.city || 'Current Location';
                    
                    reportInput.value = placeName;
                    reportPlaceCoords = { lat, lng, name: placeName };
                    reportBtn.disabled = false;
                    
                    showStatus('success', `üìç Location detected: ${placeName}`);
                  } catch (e) {
                    reportInput.value = 'Current Location';
                    reportPlaceCoords = { lat, lng, name: 'Current Location' };
                    reportBtn.disabled = false;
                  }
                  
                  currentLocationBtn.classList.remove('loading');
                },
                (error) => {
                  console.error('Geolocation error:', error);
                  let errorMsg = 'Unable to get location';
                  if (error.code === 1) errorMsg = 'Location permission denied';
                  if (error.code === 2) errorMsg = 'Location unavailable';
                  if (error.code === 3) errorMsg = 'Location request timed out';
                  showStatus('error', errorMsg);
                  currentLocationBtn.classList.remove('loading');
                },
                { enableHighAccuracy: true, timeout: 10000 }
              );
            });
          }
          
          // Add spin animation
          const style = document.createElement('style');
          style.textContent = `
            @keyframes spin { to { transform: rotate(360deg); } }
            .spin { animation: spin 1s linear infinite; }
          `;
          document.head.appendChild(style);
        })();
        
        // Global function to scroll to report zone and pre-select type
        function goToReportZone(type) {
          const reportSection = document.getElementById('report-zone');
          const zoneTypeSelect = document.getElementById('reportZoneTypeIndex');
          
          if (reportSection) {
            reportSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Pre-select the zone type
            if (zoneTypeSelect && type) {
              zoneTypeSelect.value = type;
              // Add highlight effect
              zoneTypeSelect.style.boxShadow = '0 0 0 3px rgba(14, 165, 162, 0.3)';
              setTimeout(() => {
                zoneTypeSelect.style.boxShadow = '';
              }, 2000);
            }
            
            // Focus on input after scroll
            setTimeout(() => {
              const reportInput = document.getElementById('reportPlaceInputIndex');
              if (reportInput) reportInput.focus();
            }, 500);
          }
        }
      </script>
      
      <!-- Navigation Panel (Turn-by-Turn) -->
      <div id="navigationPanel" class="navigation-panel" style="display: none;">
        <div class="navigation-header">
          <h3>üß≠ Navigation</h3>
          <button id="closeNavPanel" class="close-btn">‚úï</button>
        </div>
        <div class="navigation-content">
          <div class="next-turn">
            <div class="turn-icon" id="turnIcon">‚û°Ô∏è</div>
            <div class="turn-info">
              <div class="turn-direction" id="turnDirection">Heading towards destination</div>
              <div class="turn-distance" id="turnDistance">Calculating...</div>
            </div>
          </div>
          <div class="instructions-list" id="instructionsList" style="margin-top: 20px; display: none;">
            <h4>üìã Directions</h4>
            <ol id="directionsOL" style="padding-left: 20px;"></ol>
          </div>
        </div>
      </div>

      <style>
        .navigation-panel {
          position: fixed;
          bottom: 20px;
          right: 20px;
          width: 350px;
          max-width: 90vw;
          background: white;
          border-radius: 12px;
          box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
          z-index: 100;
          font-family: inherit;
          animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
          from {
            opacity: 0;
            transform: translateX(400px);
          }
          to {
            opacity: 1;
            transform: translateX(0);
          }
        }

        .navigation-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 15px 20px;
          border-bottom: 2px solid #f0f0f0;
          background: linear-gradient(135deg, #0EA5A2 0%, #06B6D4 100%);
          color: white;
          border-radius: 12px 12px 0 0;
        }

        .navigation-header h3 {
          margin: 0;
          font-size: 18px;
          font-weight: 600;
        }

        .close-btn {
          background: rgba(255, 255, 255, 0.2);
          border: none;
          color: white;
          font-size: 20px;
          cursor: pointer;
          padding: 0;
          width: 30px;
          height: 30px;
          border-radius: 50%;
          transition: background 0.2s;
        }

        .close-btn:hover {
          background: rgba(255, 255, 255, 0.3);
        }

        .navigation-content {
          padding: 20px;
        }

        .next-turn {
          display: flex;
          gap: 15px;
          align-items: center;
        }

        .turn-icon {
          font-size: 32px;
          min-width: 40px;
          text-align: center;
        }

        .turn-info {
          flex: 1;
        }

        .turn-direction {
          font-size: 14px;
          font-weight: 600;
          color: #0EA5A2;
          margin-bottom: 5px;
        }

        .turn-distance {
          font-size: 18px;
          font-weight: 700;
          color: #333;
        }

        .instructions-list {
          background: #f8f8f8;
          padding: 12px;
          border-radius: 8px;
          border-left: 4px solid #0EA5A2;
        }

        .instructions-list h4 {
          margin: 0 0 10px 0;
          font-size: 12px;
          color: #666;
          text-transform: uppercase;
        }

        .instructions-list ol {
          margin: 0;
          font-size: 12px;
          color: #555;
        }

        .instructions-list li {
          margin-bottom: 6px;
          line-height: 1.4;
        }

        @media (max-width: 640px) {
          .navigation-panel {
            width: calc(100% - 20px);
            bottom: 10px;
            right: 10px;
          }
        }
      </style>

      <script>
        // Theme Toggle
        (function () {
          const themeToggle = document.getElementById('themeToggle');
          if (!themeToggle) {
            console.error('Theme toggle button not found!');
            return;
          }

          console.log('Theme toggle initialized');

          themeToggle.addEventListener('click', () => {
            console.log('Theme toggle clicked');
            const html = document.documentElement;
            const body = document.body;
            
            const isDark = html.classList.toggle('dark-mode');
            body.classList.toggle('dark-mode'); // Also add to body
            
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            console.log('Theme is now:', isDark ? 'dark' : 'light');
            console.log('HTML classes:', html.className);
            console.log('Body classes:', body.className);
            console.log('Computed bg color:', getComputedStyle(body).backgroundColor);
          });
        })();

        // Welcome popup
        (function () {
          const popup = document.getElementById('welcomePopup');
          if (!popup) return;

          if (!sessionStorage.getItem('welcomeSeen')) {
            popup.style.display = 'flex';
          }

          const closePopup = () => {
            popup.style.opacity = '0';
            setTimeout(() => {
              popup.style.display = 'none';
              sessionStorage.setItem('welcomeSeen', 'true');
            }, 300);
          };

          popup.querySelector('.welcome-close').onclick = closePopup;
          popup.querySelector('.welcome-btn').onclick = closePopup;
          popup.onclick = (e) => { if (e.target === popup) closePopup(); };
          document.onkeydown = (e) => { if (e.key === 'Escape' && popup.style.display === 'flex') closePopup(); };
        })();

        // Demo: Show AI comfort prediction
        setInterval(() => {
          if (window.comfortAI) {
            const prediction = comfortAI.predict([77.4538, 28.6692], Date.now());
            console.log(`AI Comfort Level: ${(prediction * 100).toFixed(0)}%`);
          }
        }, 5000);
      </script>

      <!-- AI & Navigation Scripts -->
      <script src="ai-nlp-engine.js"></script>
      <script src="gemini-route-analyzer.js"></script>
      <script src="gemini-setup-info.js"></script>
      <script src="ai-action-handler.js"></script>
      <script src="chatbot-widget.js"></script>

      <!-- Turn-by-Turn Navigation Handler -->
      <script>
        // Navigation panel management
        let navigationState = {
          routeSegments: [],
          instructions: [],
          currentSegmentIndex: 0,
          nextTurnDistance: 0,
          nextTurnDirection: '‚û°Ô∏è'
        };

        function updateNavigationPanel() {
          const navPanel = document.getElementById('navigationPanel');
          const turnIcon = document.getElementById('turnIcon');
          const turnDirection = document.getElementById('turnDirection');
          const turnDistance = document.getElementById('turnDistance');

          if (navigationState.nextTurnDistance > 0) {
            const iconMap = {
              'left': '‚ÜôÔ∏è',
              'right': '‚ÜòÔ∏è',
              'straight': '‚¨ÜÔ∏è',
              'arrive': 'üéØ'
            };
            
            const directionText = {
              'left': 'Turn LEFT',
              'right': 'Turn RIGHT',
              'straight': 'Go STRAIGHT',
              'arrive': 'You have arrived'
            };

            turnIcon.textContent = iconMap[navigationState.nextTurnDirection] || '‚û°Ô∏è';
            turnDirection.textContent = directionText[navigationState.nextTurnDirection] || 'Continue';
            turnDistance.textContent = `${Math.round(navigationState.nextTurnDistance)}m away`;
          }
        }

        function showNavigationPanel() {
          const navPanel = document.getElementById('navigationPanel');
          navPanel.style.display = 'block';

          const closeBtn = document.getElementById('closeNavPanel');
          closeBtn.addEventListener('click', () => {
            navPanel.style.display = 'none';
          });
        }

        function hideNavigationPanel() {
          document.getElementById('navigationPanel').style.display = 'none';
        }

        // Calculate distance between two coordinates (Haversine formula)
        function calculateDistance(from, to) {
          const R = 6371000; // Earth radius in meters
          const dLat = ((to[1] - from[1]) * Math.PI) / 180;
          const dLon = ((to[0] - from[0]) * Math.PI) / 180;
          const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos((from[1] * Math.PI) / 180) *
              Math.cos((to[1] * Math.PI) / 180) *
              Math.sin(dLon / 2) *
              Math.sin(dLon / 2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
          return R * c; // Distance in meters
        }

        // Calculate bearing (compass direction) between two points
        function calculateBearing(from, to) {
          const dLon = ((to[0] - from[0]) * Math.PI) / 180;
          const y = Math.sin(dLon) * Math.cos((to[1] * Math.PI) / 180);
          const x =
            Math.cos((from[1] * Math.PI) / 180) * Math.sin((to[1] * Math.PI) / 180) -
            Math.sin((from[1] * Math.PI) / 180) *
              Math.cos((to[1] * Math.PI) / 180) *
              Math.cos(dLon);
          return (Math.atan2(y, x) * 180) / Math.PI + 360) % 360;
        }

        // Determine turn direction from bearing change
        function determineTurnDirection(fromBearing, toBearing) {
          let diff = (toBearing - fromBearing + 360) % 360;
          if (diff > 180) diff -= 360;

          if (Math.abs(diff) < 30) return 'straight';
          if (diff < 0) return 'left';
          return 'right';
        }

        // Generate turns from route coordinates
        function generateTurns(routeCoordinates) {
          if (routeCoordinates.length < 2) return [];

          const segments = [];
          for (let i = 0; i < routeCoordinates.length - 1; i++) {
            const from = routeCoordinates[i];
            const to = routeCoordinates[i + 1];
            const distance = calculateDistance(from, to);
            const bearing = calculateBearing(from, to);

            segments.push({
              from,
              to,
              distance,
              bearing,
              index: i
            });
          }

          // Determine turns
          const turns = [];
          for (let i = 0; i < segments.length - 1; i++) {
            const current = segments[i];
            const next = segments[i + 1];
            const turnDirection = determineTurnDirection(current.bearing, next.bearing);

            turns.push({
              ...current,
              nextTurnDirection: turnDirection
            });
          }

          // Add final segment
          if (segments.length > 0) {
            turns.push({
              ...segments[segments.length - 1],
              nextTurnDirection: 'arrive'
            });
          }

          return turns;
        }

        // Generate human-readable instructions
        function generateNavigationInstructions(turns) {
          if (turns.length === 0) return [];

          const instructions = ['üìç Start and head towards destination'];

          for (let i = 0; i < turns.length - 1; i++) {
            const turn = turns[i];
            const directionEmoji = {
              'left': '‚ÜôÔ∏è',
              'right': '‚ÜòÔ∏è',
              'straight': '‚¨ÜÔ∏è'
            };

            const directionText = {
              'left': 'Turn left',
              'right': 'Turn right',
              'straight': 'Continue straight'
            };

            instructions.push(
              `${directionEmoji[turn.nextTurnDirection] || 'üõ£Ô∏è'} ${directionText[turn.nextTurnDirection]} after ${Math.round(turn.distance)}m`
            );
          }

          instructions.push('üéØ You have arrived');
          return instructions;
        }

        // Setup turn-by-turn navigation from route
        function setupTurnByTurnNavigation(routeCoordinates) {
          if (!routeCoordinates || routeCoordinates.length < 2) return;

          navigationState.routeSegments = generateTurns(routeCoordinates);
          navigationState.instructions = generateNavigationInstructions(navigationState.routeSegments);
          navigationState.currentSegmentIndex = 0;

          console.log('‚úÖ Turn-by-turn navigation setup:', navigationState.instructions);

          // Display instructions in panel
          const ol = document.getElementById('directionsOL');
          if (ol) {
            ol.innerHTML = navigationState.instructions
              .map((instr) => `<li>${instr}</li>`)
              .join('');
            document.getElementById('instructionsList').style.display = 'block';
          }

          showNavigationPanel();
          updateNavigationDisplay(routeCoordinates[0], routeCoordinates);
        }

        // Update navigation display based on current location
        function updateNavigationDisplay(currentLocation, routeCoordinates) {
          if (navigationState.routeSegments.length === 0) return;

          // Find closest point on route
          let minDist = Infinity;
          let closestSegmentIndex = 0;

          for (let i = 0; i < navigationState.routeSegments.length - 1; i++) {
            const segment = navigationState.routeSegments[i];
            const distToNext = calculateDistance(currentLocation, segment.to);

            if (distToNext < minDist) {
              minDist = distToNext;
              closestSegmentIndex = i;
            }
          }

          navigationState.currentSegmentIndex = closestSegmentIndex;
          const currentSegment = navigationState.routeSegments[closestSegmentIndex];

          if (currentSegment) {
            navigationState.nextTurnDirection = currentSegment.nextTurnDirection;
            navigationState.nextTurnDistance = calculateDistance(
              currentLocation,
              currentSegment.to
            );

            updateNavigationPanel();
          }
        }

        // Expose to global scope
        window.setupTurnByTurnNavigation = setupTurnByTurnNavigation;
        window.updateNavigationDisplay = updateNavigationDisplay;
        window.navigationState = navigationState;

        console.log('‚úÖ Turn-by-turn navigation module loaded');
      </script>

      <!-- Dynamic Route Recalculation -->
      <script>
        const liveTracking = {
          active: false,
          watchId: null,
          currentLocation: null,
          destination: null,
          lastRecalculatedAt: 0,
          recalculationThreshold: 50, // meters
          minRecalculationInterval: 3000 // milliseconds
        };

        function startLiveLocationTracking(destination) {
          if (liveTracking.active) {
            console.log('‚ö†Ô∏è Live tracking already active');
            return;
          }

          if (!navigator.geolocation) {
            console.error('‚ùå Geolocation not supported');
            return;
          }

          liveTracking.destination = destination;
          liveTracking.active = true;

          console.log('üî¥ Live location tracking started');

          liveTracking.watchId = navigator.geolocation.watchPosition(
            (position) => {
              const { latitude, longitude, accuracy } = position.coords;
              liveTracking.currentLocation = [longitude, latitude];

              console.log(`üìç Location updated: ${latitude.toFixed(4)}, ${longitude.toFixed(4)} (¬±${Math.round(accuracy)}m)`);

              // Recalculate route if threshold exceeded
              const now = Date.now();
              if (now - liveTracking.lastRecalculatedAt > liveTracking.minRecalculationInterval) {
                recalculateRouteFromLiveLocation(liveTracking.currentLocation, destination);
                liveTracking.lastRecalculatedAt = now;
              }
            },
            (error) => {
              console.error('‚ùå Geolocation error:', error);
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0
            }
          );
        }

        function stopLiveLocationTracking() {
          if (liveTracking.watchId !== null) {
            navigator.geolocation.clearWatch(liveTracking.watchId);
            liveTracking.active = false;
            liveTracking.watchId = null;
            console.log('üõë Live tracking stopped');
          }
        }

        function recalculateRouteFromLiveLocation(origin, destination) {
          if (typeof window.planComfortableRoute === 'function') {
            console.log('‚úÖ Route recalculated from live location');
            window.planComfortableRoute(origin, destination, false);

            // Update navigation display if available
            if (typeof window.updateNavigationDisplay === 'function') {
              // Get current route from map datasource
              if (window.currentRouteCoordinates) {
                window.updateNavigationDisplay(origin, window.currentRouteCoordinates);
              }
            }
          }
        }

        // Expose to global scope
        window.startLiveLocationTracking = startLiveLocationTracking;
        window.stopLiveLocationTracking = stopLiveLocationTracking;
        window.recalculateRouteFromLiveLocation = recalculateRouteFromLiveLocation;
        window.liveTracking = liveTracking;

        console.log('‚úÖ Dynamic route recalculation module loaded');
      </script>

      <!-- Auth Modal Styles & Scripts -->
      <style>
        .auth-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          z-index: 10000;
        }

        .auth-modal-overlay {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.7);
          backdrop-filter: blur(4px);
        }

        .auth-modal-content {
          position: relative;
          max-width: 450px;
          max-height: 90vh;
          overflow-y: auto;
          margin: 5vh auto;
          background: white;
          border-radius: 20px;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
          from {
            opacity: 0;
            transform: translateY(-20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        .auth-modal-close {
          position: absolute;
          top: 15px;
          right: 15px;
          background: #f5f5f5;
          border: none;
          border-radius: 50%;
          width: 36px;
          height: 36px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: all 0.2s;
          z-index: 1;
        }

        .auth-modal-close:hover {
          background: #e0e0e0;
          transform: rotate(90deg);
        }

        .auth-container-modal {
          padding: 40px;
        }

        .logo-modal {
          text-align: center;
          margin-bottom: 10px;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 12px;
        }

        .logo-modal img {
          width: 50px;
          height: 50px;
          filter: drop-shadow(0 4px 8px rgba(14, 165, 162, 0.3));
        }

        .logo-modal h1 {
          color: #0EA5A2;
          font-size: 36px;
          font-weight: 700;
          margin-bottom: 0;
        }

        .tab-buttons-modal {
          display: flex;
          margin-bottom: 30px;
          background: #f5f5f5;
          border-radius: 10px;
          padding: 5px;
        }

        .tab-btn-modal {
          flex: 1;
          padding: 12px;
          border: none;
          background: transparent;
          cursor: pointer;
          font-size: 16px;
          font-weight: 500;
          color: #666;
          border-radius: 8px;
          transition: all 0.3s ease;
        }

        .tab-btn-modal.active {
          background: white;
          color: #0EA5A2;
          box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12), 0 6px 16px rgba(14, 165, 162, 0.1), inset 0 -2px 0 rgba(14, 165, 162, 0.1);
          transform: translateY(-1px);
        }

        .form-container-modal {
          display: none;
        }

        .form-container-modal.active {
          display: block;
        }

        .form-group-modal {
          margin-bottom: 20px;
        }

        .form-group-modal label {
          display: block;
          margin-bottom: 8px;
          color: #333;
          font-weight: 500;
          font-size: 14px;
        }

        .form-group-modal input {
          width: 100%;
          padding: 14px;
          border: 2px solid #e0e0e0;
          border-radius: 10px;
          font-size: 15px;
          transition: all 0.3s;
        }

        .form-group-modal input:focus {
          outline: none;
          border-color: #0EA5A2;
        }

        .submit-btn-modal {
          width: 100%;
          padding: 14px;
          background: linear-gradient(135deg, #0EA5A2 0%, #0EA5A2 100%);
          color: white;
          border: none;
          border-radius: 10px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          margin-top: 10px;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 8px 16px rgba(14, 165, 162, 0.2), inset 0 -3px 0 rgba(0, 0, 0, 0.2);
        }

        .submit-btn-modal:hover {
          transform: translateY(-3px);
          box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15), 0 12px 24px rgba(14, 165, 162, 0.3), inset 0 -3px 0 rgba(0, 0, 0, 0.2);
        }

        .submit-btn-modal:active {
          transform: translateY(1px);
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 4px 8px rgba(14, 165, 162, 0.15), inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .submit-btn-modal:disabled {
          opacity: 0.6;
          cursor: not-allowed;
          transform: none;
        }

        .divider-modal {
          text-align: center;
          margin: 25px 0;
          position: relative;
        }

        .divider-modal::before {
          content: '';
          position: absolute;
          left: 0;
          top: 50%;
          width: 100%;
          height: 1px;
          background: #e0e0e0;
        }

        .divider-modal span {
          background: white;
          padding: 0 15px;
          position: relative;
          color: #999;
          font-size: 14px;
        }

        .google-btn-modal {
          width: 100%;
          padding: 14px;
          background: white;
          color: #333;
          border: 2px solid #e0e0e0;
          border-radius: 10px;
          font-size: 15px;
          font-weight: 500;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
          transition: all 0.3s ease;
          box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08), 0 6px 12px rgba(0, 0, 0, 0.05), inset 0 -2px 0 rgba(0, 0, 0, 0.05);
        }

        .google-btn-modal:hover {
          border-color: #0EA5A2;
          background: #f8f9ff;
          transform: translateY(-2px);
          box-shadow: 0 5px 10px rgba(0, 0, 0, 0.12), 0 8px 16px rgba(14, 165, 162, 0.1), inset 0 -2px 0 rgba(0, 0, 0, 0.05);
        }

        .google-btn-modal:active {
          transform: translateY(1px);
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08), inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .google-icon {
          width: 20px;
          height: 20px;
        }

        .forgot-password-modal {
          text-align: right;
          margin-top: 10px;
        }

        .forgot-password-modal a {
          color: #0EA5A2;
          text-decoration: none;
          font-size: 14px;
        }

        .forgot-password-modal a:hover {
          text-decoration: underline;
        }

        .alert-modal {
          padding: 12px;
          border-radius: 8px;
          margin-bottom: 20px;
          font-size: 14px;
          display: none;
        }

        .alert-modal.show {
          display: block;
        }

        .alert-modal.success {
          background: #d4edda;
          color: #155724;
          border: 1px solid #c3e6cb;
        }

        .alert-modal.error {
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
        }

        .user-info-modal {
          text-align: center;
        }

        .user-avatar-modal {
          width: 80px;
          height: 80px;
          border-radius: 50%;
          margin: 0 auto 20px;
          background: linear-gradient(135deg, #0EA5A2 0%, #0EA5A2 100%);
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-size: 32px;
          font-weight: 600;
        }

        .user-name-modal {
          font-size: 24px;
          font-weight: 600;
          color: #333;
          margin-bottom: 5px;
        }

        .user-email-modal {
          color: #666;
          margin-bottom: 20px;
        }

        .action-btn-modal {
          width: 100%;
          padding: 12px;
          border: 2px solid #0EA5A2;
          background: white;
          color: #0EA5A2;
          border-radius: 10px;
          font-size: 15px;
          font-weight: 500;
          cursor: pointer;
          margin-bottom: 10px;
          transition: all 0.3s ease;
          box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08), 0 6px 12px rgba(14, 165, 162, 0.1), inset 0 -2px 0 rgba(14, 165, 162, 0.1);
        }

        .action-btn-modal:hover {
          background: #0EA5A2;
          color: white;
          transform: translateY(-2px);
          box-shadow: 0 5px 10px rgba(0, 0, 0, 0.12), 0 8px 16px rgba(14, 165, 162, 0.2), inset 0 -2px 0 rgba(0, 0, 0, 0.2);
        }

        .action-btn-modal:active {
          transform: translateY(1px);
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08), inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .signout-btn-modal {
          background: #f44336;
          border-color: #f44336;
          color: white;
          box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08), 0 6px 12px rgba(244, 67, 54, 0.2), inset 0 -2px 0 rgba(0, 0, 0, 0.2);
        }

        .signout-btn-modal:hover {
          background: #d32f2f;
          border-color: #d32f2f;
        }
      </style>

      <script type="module">
        // Import Firebase SDK v10
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
          getAuth, 
          createUserWithEmailAndPassword,
          signInWithEmailAndPassword,
          GoogleAuthProvider,
          signInWithPopup,
          signOut,
          onAuthStateChanged,
          sendPasswordResetEmail,
          updateProfile,
          updatePassword,
          EmailAuthProvider,
          reauthenticateWithCredential
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCpRStd3cJuavDoB87i_6OLS7krIl8Kkvc",
          authDomain: "rivo-maps-82621.firebaseapp.com",
          projectId: "rivo-maps-82621",
          storageBucket: "rivo-maps-82621.firebasestorage.app",
          messagingSenderId: "679917061688",
          appId: "1:679917061688:web:3adc8be2b3cfadea3f93f7",
          measurementId: "G-SYY6Y70MEL"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();

        // Make auth available globally
        window.firebaseAuth = auth;
        window.firebaseApp = app;

        // Check auth state and update UI
        onAuthStateChanged(auth, (user) => {
          if (user) {
            updateHeaderAvatar(user);
            localStorage.setItem('rivoUser', JSON.stringify({
              uid: user.uid,
              email: user.email,
              displayName: user.displayName
            }));
            if (document.getElementById('authModal').style.display !== 'none') {
              showUserInfoModal(user);
            }
          } else {
            resetHeaderToLogin();
          }
        });

        // Global modal functions
        window.openAuthModal = function() {
          document.getElementById('authModal').style.display = 'block';
          document.body.style.overflow = 'hidden';
        };

        window.closeAuthModal = function() {
          document.getElementById('authModal').style.display = 'none';
          document.body.style.overflow = 'auto';
        };

        window.switchTabModal = function(tab) {
          document.querySelectorAll('.tab-btn-modal').forEach(btn => btn.classList.remove('active'));
          document.querySelectorAll('.form-container-modal').forEach(form => form.classList.remove('active'));
          
          if (tab === 'signin') {
            document.querySelector('.tab-btn-modal:first-child').classList.add('active');
            document.getElementById('signin-form-modal').classList.add('active');
          } else {
            document.querySelector('.tab-btn-modal:last-child').classList.add('active');
            document.getElementById('signup-form-modal').classList.add('active');
          }
          hideAlertModal();
        };

        window.handleSignInModal = async function(event) {
          event.preventDefault();
          const email = document.getElementById('signin-email-modal').value;
          const password = document.getElementById('signin-password-modal').value;
          
          setLoadingModal('signin-btn-modal', true);
          try {
            await signInWithEmailAndPassword(auth, email, password);
            showAlertModal('Successfully signed in!', 'success');
            setTimeout(() => {
              window.location.href = 'index.html#home';
            }, 1500);
          } catch (error) {
            showAlertModal(getErrorMessage(error), 'error');
          }
          setLoadingModal('signin-btn-modal', false);
        };

        window.handleSignUpModal = async function(event) {
          event.preventDefault();
          const name = document.getElementById('signup-name-modal').value;
          const email = document.getElementById('signup-email-modal').value;
          const password = document.getElementById('signup-password-modal').value;
          const confirm = document.getElementById('signup-confirm-modal').value;
          
          if (password !== confirm) {
            showAlertModal('Passwords do not match', 'error');
            return;
          }
          
          setLoadingModal('signup-btn-modal', true);
          try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            await updateProfile(userCredential.user, { displayName: name });
            showAlertModal('Account created successfully!', 'success');
            setTimeout(() => {
              window.location.href = 'index.html#home';
            }, 1500);
          } catch (error) {
            showAlertModal(getErrorMessage(error), 'error');
          }
          setLoadingModal('signup-btn-modal', false);
        };

        window.handleGoogleSignInModal = async function() {
          try {
            await signInWithPopup(auth, googleProvider);
            showAlertModal('Successfully signed in with Google!', 'success');
            setTimeout(() => {
              window.location.href = 'index.html#home';
            }, 1500);
          } catch (error) {
            showAlertModal(getErrorMessage(error), 'error');
          }
        };

        window.handleSignOutModal = async function() {
          try {
            await signOut(auth);
            showAlertModal('Successfully signed out!', 'success');
            setTimeout(() => {
              document.getElementById('authFormsModal').style.display = 'block';
              document.getElementById('userInfoModal').style.display = 'none';
              resetHeaderToLogin();
            }, 1000);
          } catch (error) {
            showAlertModal(getErrorMessage(error), 'error');
          }
        };

        window.showForgotPasswordModal = async function(event) {
          event.preventDefault();
          const email = prompt('Enter your email address:');
          if (email) {
            try {
              await sendPasswordResetEmail(auth, email);
              showAlertModal('Password reset email sent!', 'success');
            } catch (error) {
              showAlertModal(getErrorMessage(error), 'error');
            }
          }
        };

        window.showForgotPasswordForm = function(event) {
          event.preventDefault();
          document.querySelectorAll('.form-container-modal').forEach(form => form.classList.remove('active'));
          document.querySelector('.tab-buttons-modal').style.display = 'none';
          document.getElementById('forgot-password-form-modal').classList.add('active');
          hideAlertModal();
        };

        window.showSignInForm = function(event) {
          event.preventDefault();
          document.querySelectorAll('.form-container-modal').forEach(form => form.classList.remove('active'));
          document.querySelector('.tab-buttons-modal').style.display = 'flex';
          document.getElementById('signin-form-modal').classList.add('active');
          document.querySelectorAll('.tab-btn-modal').forEach(btn => btn.classList.remove('active'));
          document.querySelector('.tab-btn-modal:first-child').classList.add('active');
          hideAlertModal();
        };

        window.handleForgotPasswordModal = async function(event) {
          event.preventDefault();
          const email = document.getElementById('forgot-email-modal').value;
          
          setLoadingModal('forgot-btn-modal', true);
          try {
            await sendPasswordResetEmail(auth, email);
            showAlertModal('Password reset email sent! Check your inbox.', 'success');
            setTimeout(() => showSignInForm(event), 2000);
          } catch (error) {
            showAlertModal(getErrorMessage(error), 'error');
          }
          setLoadingModal('forgot-btn-modal', false);
        };

        window.showChangePasswordForm = function() {
          document.getElementById('userInfoModal').style.display = 'none';
          document.getElementById('authFormsModal').style.display = 'none';
          document.getElementById('change-password-form-modal').style.display = 'block';
          hideAlertModal();
        };

        window.showUserInfoModal = function() {
          document.getElementById('change-password-form-modal').style.display = 'none';
          document.getElementById('userInfoModal').style.display = 'block';
          hideAlertModal();
        };

        window.handleChangePasswordModal = async function(event) {
          event.preventDefault();
          const currentPassword = document.getElementById('current-password-modal').value;
          const newPassword = document.getElementById('new-password-modal').value;
          const confirmPassword = document.getElementById('confirm-new-password-modal').value;
          
          if (newPassword !== confirmPassword) {
            showAlertModal('New passwords do not match', 'error');
            return;
          }
          
          setLoadingModal('change-password-btn-modal', true);
          try {
            const user = auth.currentUser;
            if (!user) {
              showAlertModal('No user is currently signed in.', 'error');
              return;
            }
            
            // Re-authenticate user with current password
            const credential = EmailAuthProvider.credential(user.email, currentPassword);
            await reauthenticateWithCredential(user, credential);
            
            // Update password
            await updatePassword(user, newPassword);
            
            showAlertModal('Password changed successfully!', 'success');
            setTimeout(() => {
              document.getElementById('change-password-form-modal').querySelector('form').reset();
              showUserInfoModal();
            }, 2000);
          } catch (error) {
            showAlertModal(getErrorMessage(error), 'error');
          }
          setLoadingModal('change-password-btn-modal', false);
        };

        window.handleDeleteAccountModal = async function() {
          if (!window.confirm('Are you sure you want to delete your account? This action cannot be undone.')) return;
          try {
            const user = auth.currentUser;
            if (user) {
              await user.delete();
              showAlertModal('Account deleted successfully!', 'success');
              setTimeout(() => {
                resetHeaderToLogin();
                closeAuthModal();
              }, 1500);
            } else {
              showAlertModal('No user is currently signed in.', 'error');
            }
          } catch (error) {
            if (error.code === 'auth/requires-recent-login') {
              showAlertModal('Please sign in again to delete your account.', 'error');
            } else {
              showAlertModal(getErrorMessage(error), 'error');
            }
          }
        };

        window.goToAppModal = function() {
          closeAuthModal();
        };

        function showUserInfoModal(user) {
          document.getElementById('authFormsModal').style.display = 'none';
          document.getElementById('userInfoModal').style.display = 'block';
          
          const initial = user.displayName ? user.displayName.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase();
          document.getElementById('userAvatarModal').textContent = initial;
          document.getElementById('userNameModal').textContent = user.displayName || 'User';
          document.getElementById('userEmailModal').textContent = user.email;
        }

        function updateHeaderAvatar(user) {
          const headerLoginBtn = document.getElementById('header-login-btn');
          const headerAvatar = document.getElementById('header-avatar');
          
          if (headerLoginBtn && headerAvatar && user) {
            const initial = user.displayName ? user.displayName.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase();
            headerAvatar.textContent = initial;
            headerAvatar.title = user.displayName || user.email;
            
            headerLoginBtn.style.display = 'none';
            headerAvatar.style.display = 'flex';
          }
        }

        function resetHeaderToLogin() {
          const headerLoginBtn = document.getElementById('header-login-btn');
          const headerAvatar = document.getElementById('header-avatar');
          if (headerLoginBtn && headerAvatar) {
            headerLoginBtn.style.display = 'inline-flex';
            headerAvatar.style.display = 'none';
          }
        }

        function showAlertModal(message, type) {
          const alert = document.getElementById('alertModal');
          alert.textContent = message;
          alert.className = `alert-modal ${type} show`;
          
          setTimeout(() => {
            alert.classList.remove('show');
          }, 5000);
        }

        function hideAlertModal() {
          document.getElementById('alertModal').classList.remove('show');
        }

        function setLoadingModal(btnId, loading) {
          const btn = document.getElementById(btnId);
          btn.disabled = loading;
          
          const buttonTexts = {
            'signin-btn-modal': loading ? 'Signing in...' : 'Sign In',
            'signup-btn-modal': loading ? 'Creating account...' : 'Create Account',
            'forgot-btn-modal': loading ? 'Sending...' : 'Send Reset Link',
            'change-password-btn-modal': loading ? 'Changing...' : 'Change Password'
          };
          
          btn.textContent = buttonTexts[btnId] || (loading ? 'Please wait...' : 'Submit');
        }

        function getErrorMessage(error) {
          switch (error.code) {
            case 'auth/user-not-found':
              return 'No account found with this email address.';
            case 'auth/wrong-password':
              return 'Incorrect password. Please try again.';
            case 'auth/email-already-in-use':
              return 'An account with this email already exists.';
            case 'auth/weak-password':
              return 'Password should be at least 6 characters long.';
            case 'auth/invalid-email':
              return 'Please enter a valid email address.';
            case 'auth/popup-closed-by-user':
              return 'Sign-in popup was closed. Please try again.';
            default:
              return error.message || 'An error occurred. Please try again.';
          }
        }
      </script>
      
      <script>
        // ===== AZURE MAPS CONFIGURATION =====
        const AZURE_MAPS_KEY = 'YOUR_AZURE_MAPS_KEY';
        
        let map, datasource, startMarker, endMarker;
        let startCoords = [76.8, 30.755];
        let endCoords = [76.78, 30.74];
        
        function initAzureMap() {
          if (AZURE_MAPS_KEY === 'YOUR_AZURE_MAPS_KEY') {
            document.getElementById('azureMap').innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;background:#e8f5f5;color:#0EA5A2;font-size:18px;border-radius:12px;text-align:center;">üó∫Ô∏è Azure Maps Demo<br><small>Add your API key to activate</small></div>';
            return;
          }
          
          map = new atlas.Map('azureMap', {
            center: [76.7794, 30.7333],
            zoom: 12,
            view: 'Auto',
            authOptions: {
              authType: 'subscriptionKey',
              subscriptionKey: AZURE_MAPS_KEY
            },
            style: 'road'
          });
          
          map.events.add('ready', () => {
            datasource = new atlas.source.DataSource();
            map.sources.add(datasource);
            
            // Add layers for zones
            map.layers.add(new atlas.layer.PolygonLayer(datasource, null, {
              fillColor: ['get', 'fillColor'],
              fillOpacity: ['get', 'fillOpacity']
            }));
            
            // Add markers
            startMarker = new atlas.HtmlMarker({
              position: startCoords,
              htmlContent: '<div style="background-color:#0EA5A2;width:16px;height:16px;border-radius:50%;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>'
            });
            map.markers.add(startMarker);
            
            endMarker = new atlas.HtmlMarker({
              position: endCoords,
              htmlContent: '<div style="background-color:#214141;width:24px;height:24px;border-radius:50%;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>'
            });
            map.markers.add(endMarker);
          });
        }
        
        // Google Maps Configuration
        let googleMapInstance;
        
        function initGoogleMap() {
          const apiKey = 'YOUR_GOOGLE_MAPS_API_KEY';
          if (apiKey === 'YOUR_GOOGLE_MAPS_API_KEY') {
            document.getElementById('googleMap').innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;background:#e8f5f5;color:#0EA5A2;font-size:18px;border-radius:12px;text-align:center;">üó∫Ô∏è Google Maps Demo<br><small>Add your API key to activate</small></div>';
            return;
          }
          
          googleMapInstance = new google.maps.Map(document.getElementById('googleMap'), {
            zoom: 13,
            center: { lat: 28.6692, lng: 77.4538 },
            mapTypeId: 'roadmap'
          });
        }
        
        function toggleGoogleMapType() {
          if (googleMapInstance) {
            const currentType = googleMapInstance.getMapTypeId();
            googleMapInstance.setMapTypeId(currentType === 'roadmap' ? 'satellite' : 'roadmap');
          }
        }
        
        function centerGoogleMap() {
          if (googleMapInstance && navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
              const userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };
              googleMapInstance.setCenter(userLocation);
            });
          }
        }
        
        // Initialize maps when ready
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(() => {
            initAzureMap();
            initGoogleMap();
          }, 1000);
        });
      </script>
      
      <!-- Google Maps API -->
      <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initGoogleMap"></script>
</body>

</html>